<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>市场价</title>
    <link rel="stylesheet" type="text/css" href="../../../css/common/public.css" />
    <script type="text/javascript" src="../../../script/common/rem.js"></script>
    <style>
				html,body{
					text-align: center;
					position: relative;
					height: 100%;width: 100%;
					overflow-x: hidden;
					overflow-y: auto;
					background-color: #fff;
				}
				body>div,body>ul{
					background-color: #fff;
				}
				.marketTitleBox{
						height: 1.1rem;
						width: 100%;
						display: -webkit-box;
						display: -webkit-flex;
						display:flex;

						-webkit-box-orient: horizontal;
						-webkit-flex-flow: row;
						flex-flow: row;

						-webkit-box-pack: center;
						-webkit-justify-content: center;
						justify-content: center;

						-webkit-box-align: center;
						-webkit-align-items: center;
						align-items: center;
				}
				.marketTitleBox .marketTitle{
						color: #666666;
						font-size: 0.32rem;
						min-width: 2.0rem;
						max-width: 70%;
						text-align: center;
						height: 100%;line-height: 1.3rem;
						overflow-x: auto;
						overflow-y: hidden;
						white-space: nowrap;
				}
				.marketTitleBox .marketTitle-icon{
						width:15px;height: 15px;margin-right: 5px;margin-top: 5px;
						background-position: center center;
						background-size: 100% 100%;
						background-repeat: no-repeat;
						background-image: url('../../../image/market/price.png');
				}
				.nav{
						height:1.05rem;
						width: 100%;
						padding: 0  0.3rem;
						display: -webkit-box;
						display: -webkit-flex;
						display:flex;

						-webkit-box-orient: horizontal;
						-webkit-flex-flow: row;
						flex-flow: row;

						-webkit-box-pack: justify;
						-webkit-justify-content: space-between;
						justify-content: space-between;

						-webkit-box-align: end;
						-webkit-align-items: flex-end;
						align-items: flex-end;
				}
				.nav li{
				  width: 30%;
				  height: 0.75rem;
					background-color: #fff;
					border-radius: 4px;
					display: -webkit-box;
					display: -webkit-flex;
					display:flex;

					-webkit-box-orient: horizontal;
					-webkit-flex-flow: row;
					flex-flow: row;

					-webkit-box-pack: center;
					-webkit-justify-content: center;
					justify-content: center;

					-webkit-box-align: center;
					-webkit-align-items: center;
					align-items: center;
				}
				.nav li.nav-active1{
					background-color: #fff;
					color: #00c558;
					border: solid 1px #00c558;
				}
				.nav li.nav-active2{
					background-color: #fff;
					color: #f5c130;
					border: solid 1px #f5c130;
				}
				.nav li.nav-active3{
					background-color: #fff;
					color: #75a1fa;
					border: solid 1px #75a1fa;
				}
				.nav li>span{
				    font-size: 0.3rem;height: 100%;
				}
				.nav li>span.date-icon{
						width: 15px;
						height: 8px;margin-left: 3px;
						background-position: center center;
						background-size: 100% 100%;
						background-repeat: no-repeat;
				}
				.nav li>span.market-date{
						max-width: 80%;
						text-align: center;
						height: 100%;line-height: 0.75rem;
						overflow-x: auto;
						overflow-y: hidden;
						white-space: nowrap;
				}
				.content{
						width: 100%;
						height: 6.0rem;
						position: relative;
				}
				.content>div.contentBox{
						width: 100%;
						height: 100%;
						padding: 0.2rem 0.2rem 0.4rem 0.2rem;
						background-color: #fff;
						position: absolute;
						left: 0;
						top: 0;
						display: none;
				}
				.content>div.contentBox>div{
						width: 100%;
						height: 100%;
						background-color: #fff;
						border: solid 1px #00c558;
						border-radius: 4px;
						display: -webkit-box;
						display: -webkit-flex;
						display:flex;

						-webkit-box-orient: horizontal;
						-webkit-flex-flow: row;
						flex-flow: row;

						-webkit-box-pack: center;
						-webkit-justify-content: center;
						justify-content: center;

						-webkit-box-align: center;
						-webkit-align-items: center;
						align-items: center;
				}
				.chartEmpty{
						font-size: 0.32rem;
						color: #999999;
						background: url('../../../image/market/worn.png') no-repeat left center;
						background-size: 15px 15px;
						padding-left: 20px;
				}
    </style>
</head>
<body>
		<input type="hidden" name="plantId" id="plantId">
		<ul class="nav">
				<li class="nav-active1"><span id="market0" data-date="7" data-id="" data-provinceId="" class="market-date"  onclick="openMarketWin(this);">选择市场</span><span class="date-icon" style="background-image: url('../../../image/market/more-green.png');"></span></li>
				<li class="nav-active2"><span id="market1" data-date="7" data-id="" data-provinceId="" class="market-date"  onclick="openMarketWin(this);">选择市场</span><span class="date-icon" style="background-image: url('../../../image/market/more-yel.png');"></span></li>
				<li class="nav-active3"><span id="market2" data-date="7" data-id="" data-provinceId="" class="market-date"  onclick="openMarketWin(this);">选择市场</span><span class="date-icon" style="background-image: url('../../../image/market/more-blue.png');"></span></li>
		</ul>
		<div class="marketTitleBox">
				<span class="marketTitle-icon"></span>
				<span class="marketTitle">近7天价格对比</span>
		</div>
		<div class="content">
				<div class="contentBox" style="display:block;">
						<div class="chartBox" id="myChart"></div>
				</div>
		</div>
</body>
<script type="text/javascript" src="../../../script/common/api.js"></script>
<script type="text/javascript" src="../../../script/common/jquery.min.js"></script>
<script type="text/javascript" src="../../../script/common/pds.ajax.js"></script>
<script type="text/javascript" src="../../../script/planting/echarts.common.min.js"></script>
<script type="text/javascript">
	//var myChart = null;
	//var marketArr = [];//保存默认市场数据*******************************
	// var chartOptionObj = {	//保存chart配置项参数
	// 		xAxisData : [],
	// 		yAxisName : "",
	// 		series : [],
	// 		legend : []
	// };
	var chartH = null;//chart盒子高
	var chartW = null;//chart盒子宽
	apiready = function(){
			api.parseTapmode();
			//初始化图表
			chartH = $('.chartBox').height();//chart盒子高
			chartW = $('.chartBox').width();//chart盒子宽
			//作物Id赋值
			plantDo(api.pageParam.plantId, api.pageParam.plantName);
			//获取历史市场
			var marketObjs = $api.getStorage('markets');//alert("本地市场数据缓存************"+JSON.stringify(marketObjs))
			if (marketObjs != undefined && marketObjs != "" && marketObjs != null && marketObjs != {}) {
					$(".market-date").each(function(index,el){
							var marketName = marketObjs[index].marketName;
							var marketId = marketObjs[index].marketId;
							var provinceId = marketObjs[index].provinceId;
							var nameBoxId = $(this).attr("id");
							if (marketName != "" && marketName != null && marketId != "" && marketId != null && provinceId != "" && provinceId != null) {
									//写入市场名字，并写入缓存
									nameDo(nameBoxId, marketName, marketId, provinceId);
							}else {
									$(this).text("选择市场").attr("data-id","").attr("data-provinceId","");
							};
					});
			}else{
					//打开默认市场
					getMarket();
			};

			dataInit()


	};

	//请求默认市场数据
	function getMarket(){
			pds.ajaxSubmit({
					type: "GET",
					url : "app/price/defaultMultiMarketStat",
					success:function(e){
							//alert("success");
							//alert(JSON.stringify(e));
							if (e.status == "ok") {
									if (e.data != "" && e.data != null && e.data != {}) {
											var marketsData = e.data;
											$(".market-date").each(function(index,el){
													(function(i, this_){
															var marketName = marketsData[i].abbreviation;
															var marketId = marketsData[i].id;
															var provinceId = marketsData[i].provinceId;
															var boxId = $(this_).attr("id");

															if (marketName != "" && marketName != null && marketId != "" && marketId != null && provinceId != "" && provinceId != null) {
																	//写入市场名字，并写入缓存
																	nameDo(boxId, marketName, marketId, provinceId);
															}else {
																	$(this).text("选择市场").attr("data-id","").attr("data-provinceId","");
															};
													})(index,el)
											});
											//$api.setStorage('markets', marketArr);
									}else{
											$(".market-date").each(function(index,el){
													$(this).text("选择市场").attr("data-id","").attr("data-provinceId","");
											})
									}
							}else {
									//api.alert({msg: '获取数据失败，请重试！'});
									$(".market-date").each(function(index,el){
											$(this).text("选择市场").attr("data-id","").attr("data-provinceId","");
									})
							}

					},
					error : function(e){
							//api.alert({msg: '获取数据失败，请重试！'});
							$(".market-date").each(function(index,el){
									$(this).text("选择市场").attr("data-id","").attr("data-provinceId","");
							});
					}
			});
	}

	//市场框赋值
	function nameDo(nameBox, marketName, marketId, provinceId){
			$("#"+nameBox).text(marketName).attr("data-id",marketId).attr("data-provinceId",provinceId);
			//var index = parseInt(nameBox[6]);
			//var plantId = $("#plantId").val();
			//var statDays = 7;
			//创建缓存
			var marketArr = (function(){
				  var marketArr_ = [];
					$(".market-date").each(function(index, el){
							var name_ = $(this).text();
							var id_ = $(this).attr("data-id");
							var provinceId_ = $(this).attr("data-provinceId");
							var marketObj = {
									marketName : name_,
									marketId : id_,
									provinceId : provinceId_
							};
							marketArr_[index] = marketObj;
					});
					return marketArr_;
			})()
			//alert(JSON.stringify(marketArr))
			$api.setStorage('markets', marketArr);
			//数据修改
			//myChartInit(nameBox, plantId, marketId, marketName, statDays, index);


	};

	//作物Id赋值
	function plantDo(id, name){
			$("#plantId").val(id);
			var plantObj = {
					name : name,
					id : id
			};
			$api.setStorage('plant', plantObj);
	};

	//创建折线图
	//**************************************************************
	function dataInit(){
			var statDays = 10;
			var chartBoxs = $("#myChart").attr("id");
			var plantId = $("#plantId").val();//获取作物id
			var marketId0 = parseInt($("#market0").attr("data-id"));
			var marketId1 = parseInt($("#market1").attr("data-id"));
			var marketId2 = parseInt($("#market2").attr("data-id"));

			var marketInfo = {
					marketIds : [],
					marketNames : []
			};
			if (marketId0 != "") {
					marketInfo.marketIds.push(marketId0);
					var marketName1 = $("#market0").text();
					marketInfo.marketNames.push(marketName1);

			};
			if (marketId1 != "") {
					marketInfo.marketIds.push(marketId1);
					var marketName2 = $("#market1").text();
					marketInfo.marketNames.push(marketName2);
			};
			if (marketId2 != "") {
					marketInfo.marketIds.push(marketId2);
					var marketName3 = $("#market2").text();
					marketInfo.marketNames.push(marketName3);
			};
			myChartInit(chartBoxs, plantId, statDays, marketInfo)

	};

	//或取图表数据
	function myChartInit(boxId, plantId, statDays, marketInfo){
			//alert(plantId+"********"+marketId+"*******"+statDays+"********"+index)
			var myChart = echarts.init(document.getElementById("myChart"));
			//显示加载进度
			myChart.showLoading({
					default: {
						// text: 'loading',
						color: '#c23531',
						textColor: '#000',
						maskColor: 'rgba(255, 255, 255, 0.8)',
						zlevel: 0
					}
			});
			//marketInfo.marketIds = [204,205,58];
			var option = {
					marketIds : marketInfo.marketIds,
					categoryId : 1,
					statDays : 10
			};
			//alert(JSON.stringify(option))
			pds.ajaxSubmit({
					type: "GET",
					url : "app/price/multiMarketDayStat",
					data:{
						 data : JSON.stringify(option),
					},
					//data : option,
					success:function(e){
							//alert("success");
							//alert(JSON.stringify(e));
							myChart.hideLoading();
							if (e.status == "ok") {
									if (e.data != "" && e.data != null && e.data != {}) {
											var option_ = createData(e.data, statDays, boxId, myChart, marketInfo);
											createChart(option_, myChart)
									}else{
											$("#"+boxId).html('<span class="chartEmpty">暂无近期价格对比信息，换个条件看看吧~</span>')
									}
							}else {
									//api.alert({msg: '获取数据失败，请重试！'});
									$("#"+boxId).html('<span class="chartEmpty">暂无近期价格对比信息，换个条件看看吧~</span>')

							}

					},
					error : function(e){
							//api.alert({msg: '获取数据失败，请重试！'});
							$("#"+boxId).html('<span class="chartEmpty">暂无近期价格对比信息，换个条件看看吧~</span>')

					}
			});
	};

	//解析数据
	function createData(data, statDays, boxId, myChart, marketInfo){
			//alert(boxId+"********"+marketName+"*******"+statDays+"********"+index)
			var chartOptionObj = {	//保存chart配置项参数
					xAxisData : [],
					yAxisName : "",
					series : [],
					legend : []
			};
			var dataList = data.list;
			if (dataList != "" && dataList != null && dataList != []) {
					//console.log("有数据啦*****************")
					for (var i = 0; i < dataList.length; i++) {
							var lineData = dataList[i];//alert(JSON.stringify(lineData))
							var seriesData = [];
							var name = "";
							if (lineData != "" && lineData != null && lineData != []) {
									for (var j = 0; j < lineData.length; j++) {
											//legend赋值
											if (lineData[j].marketId != "" && lineData[j].marketId != null) {
													var marketIds = marketInfo.marketIds;
													var marketName = "";

													name = (function(marketName_){
															for (var k = 0; k < marketIds.length; k++) {
																	if (marketIds[k] == lineData[j].marketId) {
																			chartOptionObj.legend.push(marketInfo.marketNames[k]);
																			marketName_ = marketInfo.marketNames[k];
																	}
															};
															return marketName_
													})(marketName);
													//横纵坐标赋值
													chartOptionObj.xAxisData[j] = lineData[j].statDate;
													chartOptionObj.yAxisName = lineData[j].unit;
													//series赋值

													var price = lineData[j].price;
													if (price == null) {
															price = "无";
													}else{
															price = price.toFixed(2); //输出结果为两位小数
													};
													seriesData[j] = price;
											};
									}
							}


							var priceObj = {
									name : name,
									type :'line',
									//stack : '总量',
									data : seriesData
							};
							chartOptionObj.series.push(priceObj);//*********************
					};

			}else{
					console.log("空空如也")
					//$("#"+boxId).html('<span class="chartEmpty">暂无近'+ statDays +'天价格对比，换个条件看看吧~</span>')
			};
			return chartOptionObj;

	}

	//创建图表
	function createChart(chartOptionObj, myChart){
			//alert("chart数据***************"+JSON.stringify(chartOptionObj.series))
			//alert(JSON.stringify(series));
			if (chartOptionObj.series.length == 0 || chartOptionObj.xAxisData.length == 0) {
					$("#myChart").html('<span class="chartEmpty">暂无近'+ 7 +'天价格对比，换个条件看看吧~</span>')
					return;
			};
			//参数配置
			var myOption = {
					tooltip: {//弹窗
							trigger: 'axis',
							//triggerOn : 'click',//'mousemove|click'
							backgroundColor : 'rgba(50,50,50,0.7)',
							textStyle:{
					　　		align:'left'
					　　}
					},
					legend: {//图例
							data : chartOptionObj.legend,
							//bottom : 10
					},
					grid: {
							left: '7%',
							right: '7%',
							bottom: '5%',
							containLabel: true,
							borderColor:'#f09d71'
					},
					xAxis: {//X轴
							type: 'category',
							boundaryGap: false,
							axisLine:{
									lineStyle:{
											color : '#f09d71',
											shadowBlur: 10
									}
							},
							data: chartOptionObj.xAxisData
					},
					yAxis: {//Y轴
							type: 'value',
							name: chartOptionObj.yAxisName,
							axisLine:{
									lineStyle:{
											color : '#f09d71',
											shadowBlur: 10
									}
							},
					},
					series: chartOptionObj.series
			};
			// 使用刚指定的option配置项和数据显示图表。
			myChart.setOption(myOption);
			//固定图表大小
			//console.log(chartW+"******"+chartH)
			myChart.resize({
					width : chartW,
					height : chartH
			});
			// setTimeout(function(){
			// 		myChart.hideLoading();
			// },1500);

	};

	//打开市场页面***************************************************
	function openMarketWin(obj){
		var nameBoxId = $(obj).attr("id");
		var marketName = $(obj).text();
		var provinceId = $(obj).attr("data-provinceId");
		var marketId = $(obj).attr("data-id");
		api.openWin({
			name : "market-choose-win",
			url : "widget://html/home/marketInfo/market-choose-win.html",
			reload : true,
			pageParam : {
					provinceId : provinceId,
					marketId : marketId,
					frmName : api.frameName,
					nameBoxId : nameBoxId
			},
			animation : {
				type : "movein", //动画类型（详见动画类型常量）
				subType : "from_right", //动画子类型（详见动画子类型常量）
				duration : 300 //动画过渡时间，默认300毫秒
			}
		});
	};

	//返回上一级********************************************************************
	function back(){
			api.closeFrame();
	}
</script>
</html>
