<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title>效率分析图</title>
  		<link rel="stylesheet" href="../../../css/common/public.css" />
  		<link rel="stylesheet" href="../../../css/common/header.css" />
  		<link rel="stylesheet" href="../../../css/efficiency/efficiency_win.css" />
      <script type="text/javascript" src="../../../script/common/rem.js"></script>
      <link rel="stylesheet" type="text/css" href="../../../css/common/mui.min.css"/>
  		<link rel="stylesheet" type="text/css" href="../../../css/common/mui.picker.min.css"/>
  </head>
  <body>
    <div id="header">
            <div class="headerLeft" onclick="api.closeWin()"></div>
            <div class="headerCenter">效率分析图</div>
            <div class="headerRight"></div>
    </div>
    <article>
        <section id="section1">
            <ul>
              <li>
                <input class="dis_ipt" id="time" type="text" value="2017年1月-2017年10月" readonly onclick="timeStyle()">
              </li>
              <li>
                <input class="dis_ipt" id="farm" type="text" value="一号基地一号基地一号基地" readonly onclick="farmStyle()">
              </li>
            </ul>
        </section>
        <!-- 时间弹窗 -->
        <section id="section2">
              <nav class="section-title border1">
                  选择统计时间<span class="small">（必选）</span>
              </nav>
                <ul id="timeContain">
                  <li>
                    <span>开始时间：</span>
                    <span id="time1">
                      <input id="date1" type="text" placeholder="点击我选择时间" readonly>
                      <i></i>
                    </span>
                  </li>
                  <li>
                    <span>结束时间：</span>
                    <span id="time2">
                      <input id="date2" type="text" placeholder="点击我选择时间" readonly>
                      <i></i>
                    </span>
                  </li>
                </ul>
                <div class="btns">
                  <div class="time_btn" onclick="cropGrowth()">确定</div>
                  <div class="time_btn" onclick="closeSection()">取消</div>
                </div>
        </section>
        <!-- 基地弹窗 -->
        <section id="section3">
                <nav class="section-title title">
                   <i></i><span>提示:最多可选择5个基地对比分析</span>
                </nav>
                <section id="section_special" class='clearfix'>

                </section>
                <div class="btns_farm" style="display:flex;">
                  <div class="farm_btn">确定</div>
                  <div class="farm_btn" onclick="closeFarm()">取消</div>
                </div>
      	</section>

        <div id="other">
              <section>
                   <div id="plan_content">
                        <div class="plan_title" class="clearfix">
                            <i></i><span>工单完成情况分析</span><i></i>
                        </div>
                   </div>
                   <div id="container1"></div>
             </section>
             <section>
                 <div id="plan_content">
                      <div class="plan_title" class="clearfix">
                          <i></i><span>基地人员在岗时长</span><i></i>
                      </div>
                 </div>
                 <div id="container2"></div>
             </section>
           <section>
                 <div id="plan_content">
                      <div class="plan_title" class="clearfix">
                          <i></i><span>基地人员公里数</span><i></i>
                      </div>
                 </div>
                 <div id="container3"></div>
           </section>
        </div>
   </acticle>
  </body>
  <script type="text/javascript" src="../../../script/common/api.js"></script>
  <script type="text/javascript" src="../../../script/common/jquery.min.js"></script>
  <script type="text/javascript" src="../../../script/common/pds.ajax.js"></script>
  <script type="text/javascript" src="../../../script/mui/mui.min.js"></script>
  <script type="text/javascript" src="../../../script/mui/mui.picker.min.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <script src="http://code.highcharts.com/highcharts-3d.js"></script>
  <script src="https://cdn.bootcss.com/echarts/3.8.4/echarts.common.min.js"></script>
  <script src="https://cdn.bootcss.com/echarts/3.8.4/echarts.js"></script>
  <script src="https://cdn.bootcss.com/echarts/3.8.4/extension/dataTool.js"></script>
  <script type="text/javascript">
      apiready = function(){
          var header = $api.byId('header');
          $api.fixStatusBar(header);
          var headerH = $api.offset(header).h;
          $("body").css({"paddingTop":headerH+"px"});
          show();
          // 调用事件插件
              $("#time1").bind("touchstart",function(){
                  $("#time1").unbind("touchstart")
                  mui.init()
                  var texts = $( '#date1' )
                  texts.on( 'tap', function () {
                      api.setFrameAttr( {
                       name: 'record_frm',//固定日历控件
                       bounces: false
                      } )

                      var dtpicker = new mui.DtPicker( {
                       type: 'date', //设置日历初始视图模式
                       labels: [ '年', '月', '日' ], //设置默认标签区域提示语
                      } )
                      dtpicker.show(function(rs) {
                       //console.log( JSON.stringify( rs ) );
                       var dateValue = JSON.parse(JSON.stringify( rs ));

                       //console.log(dateValue.value);
                       var beginDate=rs.y.text + '-' + rs.m.text + '-' + rs.d.text;
                       var endDate=$("#date2").val();
                       var d1 = new Date(beginDate.replace(/\-/g, "\/"));
                       var d2 = new Date(endDate.replace(/\-/g, "\/"));

                       if(beginDate!=""&&endDate!=""&&d1 >d2)
                       {
                        alert("开始时间不能大于结束时间！");
                        return false;
                       }
                       texts.val(rs.y.text + '-' + rs.m.text + '-' + rs.d.text)

                       dtpicker.dispose()
                       api.setFrameAttr( {
                         name: 'record_frm',
                         bounces: true
                       } )
                      } )
                } )
              })

                $("#time2").on("touchstart",function(){
                  $("#time2").unbind("touchstart")
                  mui.init()
                  var texts = $( '#date2' )
                  texts.on( 'tap', function () {
                      api.setFrameAttr( {
                       name: 'record_frm',//固定日历控件
                       bounces: false
                      } )

                      var dtpicker = new mui.DtPicker( {
                       type: 'date', //设置日历初始视图模式
                       labels: [ '年', '月', '日' ], //设置默认标签区域提示语
                      } )
                      dtpicker.show( function(rs){
                       //console.log( JSON.stringify( rs ) );
                       var dateValue = JSON.parse(JSON.stringify( rs ));

                       //console.log(dateValue.value);
                       var beginDate=$("#date1").val();
                       var endDate=rs.y.text + '-' + rs.m.text + '-' + rs.d.text;
                       var d1 = new Date(beginDate.replace(/\-/g, "\/"));
                       var d2 = new Date(endDate.replace(/\-/g, "\/"));

                      if(beginDate!=""&&endDate!=""&&d1 >d2)
                       {
                        alert("开始时间不能大于结束时间！");
                        return false;
                       }
                       texts.val(rs.y.text + '-' + rs.m.text + '-' + rs.d.text)

                       dtpicker.dispose()
                       api.setFrameAttr( {
                         name: 'record_frm',
                         bounces: true
                       })
                      })
                })
              });

          initIn();
          //getOrder();
          getWorkOrder();
          getWorkTime();
          getlongNess();
};

      function timeStyle(){
        $('#section2').toggleClass('active');
        if($('#section3').hasClass("active")){
          $('#section3').removeClass('active')
        }
      }
      function farmStyle(){
        $('#section3').toggleClass('active');
        if($('#section2').hasClass("active")){
          $('#section2').removeClass('active')
        }
      }

      function cropGrowth() {
      	if(!$("#date1").val()){
      		api.alert({msg:"请点击选择开始时间"});
      		return
      	}
      	if(!$("#date2").val()){
      		api.alert({msg:"请点击选择结束时间"});
      		return
      	}
      	$api.setStorage('startDates',$("#date1").val())
      	$api.setStorage('endDates',$("#date2").val())
        initIn(1)
        $('#section2').removeClass('active')
      }
      function closeSection(){
        $('#section2').removeClass('active')
      }
      function closeFarm(){
        $('#section3').removeClass('active')
      }

      function show(){
      	// row.style.backgroundColor="#E4FFDD"
      	//row.style.border="1px solid #00c558"
        api.ajax({
          headers : {
            authorization : $api.getStorage("userId") == undefined? null : $api.getStorage("userId")
        },
          url:pds.defaultUri + 'app/staff/farmland/get_farm_list',
        },function(ret,err){
          if (ret) {
      			    //api.alert({msg:JSON.stringify(ret)});
                var str=""
                for(var i=0;i<ret.data.length;i++){
                  str+= "<p id=id"+ret.data[i].id+" class=\"section-p\" onclick='changeColor(this)'>"+ret.data[i].farmName+"</p>"
                }
               $('#section_special').html(str);
      			}else {
              //api.alert({msg:JSON.stringify(err)});
            };
          });
      }

        var dian=0;
        var idArray = [];
        function changeColor(dom){
          if($(dom).hasClass("you")){
            $(dom).removeClass("you");
            dom.style.backgroundColor="#fff";
            var biaoshi = idArray.indexOf(id);
            if(biaoshi){
               idArray.splice(biaoshi,1);
            }
            $(dom).find("span").remove();
            // alert(JSON.stringify(idArray));
            dian--
          }else{
            if(dian>4){
              return;
            }
            var id=dom.id.substring(2);
            var p=document.getElementById("section_special").getElementsByTagName("p");
            $(dom).addClass("you");
            $(dom).html($(dom).html()+"<span class='ok'><span><span class='ic'></span>")
            idArray.push(id);
            dian++
            dom.style.backgroundColor="#E4FFDD"
          }
        }

          function initIn(n){
        		back=n;
        		if(n){
        			var startDate=$api.getStorage('startDates');
        			var endDate=$api.getStorage('endDates');
        			console.log(startDate);
        			console.log(endDate);
        			var result = GetDateDiff(startDate, endDate, "day");
        			console.log(result);
        			$("#time").val(startDate.substring(0,4)+"年"+startDate.substring(5,7)+"月-"+endDate.substring(0,4)+"年"+endDate.substring(5,7)+"月")

             // 发送ajax请求数据渲染工单图标
        			// $.ajax({
        			// 	 url:"./json/workOrder.json",
        			// 	 type : "GET",
        			// 	 success:function(e){
        			// 		  alert('success')
        			// 			//alert(e)
        			// 			var orderData = JSON.parse(e).data;
        			// 			var categories = [];
        			// 			var sendData = [];
        			// 			var finishData = [];
        			// 			for (var i = 0; i < orderData.length; i++) {
        			// 				categories.push(orderData[i]['farmName'])
        			// 				sendData.push(orderData[i]['send'])
        			// 				finishData.push(orderData[i]['finish'])
              //       }
        			// 			alert(categories);
        			// 			alert(sendData);
        			// 			alert(finishData);
        			// 			getOrder(categories,sendData,finishData)
        			//
        			// 	 },
        			// 	 error:function(e){
        			// 			api.alert({msg:"服务器异常，请联系管理员!"});
        			// 	 }
        			// });

        		}else{
        			var d = new Date(), y = d.getFullYear(), m = d.getMonth() + 1, r = d.getDate();
        			m < 10 ? m = "0" + m : m;
        			r < 10 ? r = "0" + r : r;
        			var endDate=y + "-" + m + "-" + r;
        			var startDate=y + "-0" + 1 + "-0" + 1;
        			$("#time").val(y+"年0"+1+"月-"+y+"年"+m+"月")
        			$.ajax({
        				 url:"./json/workOrder.json",
        				 type : "GET",
        				 success:function(e){
        					  // alert('success')
        						//alert(e)
        						var orderData = JSON.parse(e).data;
        						var categories = [];
        						var sendData = [];
        						var finishData = [];
        						for (var i = 0; i < orderData.length; i++) {
        							categories.push(orderData[i]['farmName'])
        							sendData.push(orderData[i]['send'])
        							finishData.push(orderData[i]['finish'])
                    };
        						var seriesData=[];
        						seriesData[0]={};
        						seriesData[1]={};
        						seriesData[0].data=[];
        						seriesData[1].data=[];
        						seriesData[0].data= sendData;
        						seriesData[1].data= finishData;
        						seriesData[0].name="派发工单量";
        						seriesData[1].name="完成工单量";
        						seriesData[0].color="#b8cafa";
        						seriesData[1].color="#eb95f0";
        						// getOrder(categories,seriesData);
        				 },
        				 error:function(e){
        						api.alert({msg:"服务器异常，请联系管理员!"});
        				 }
        			});
        		}
        	}



        function getWorkOrder(){
          var option1 = {
                backgroundColor: '#ffffff',
                legend: {
                    bottom: 0,
                    textStyle:{
                        color:'#666666',
                    },
                    data:[{name:'派发工单量',backgroundColor:'red'},
                          {name:'完成工单量',backgroundColor:'#B5C334'}
                    ],
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                tooltip: {
                     show:"false",
                     trigger: 'axis',
                     zIndex:"100",
                     axisPointer: { // 坐标轴指示器，坐标轴触发有效
                         type: 'shadow',
                         shadowStyle : {                       // 阴影指示器样式设置
                          width: 'auto',                   // 阴影大小
                          }// 默认为直线，可选为：'line' | 'shadow'
                     }
                 },
                xAxis:  {
                    type: 'value',
                    axisTick: {
                        show: false
                    },
                    axisLine: {
                      lineStyle: {
                          color: '#c8cbc8',
                          type:'dashed'
                      }
                    },
                    axisLabel :{
                      color: "#666666"
                    },
                    splitLine: {
                        show: false
                    },
                    maxInterval : 5,
                    maxInterval:20
                },
                yAxis: [
                        {
                            type: 'category',
                            axisTick : {
                              show: false
                            },
                            axisLine: {
                              lineStyle: {
                                  color: '#c8cbc8',
                                  type:'dashed'
                              }
                            },
                            axisLabel :{
                 								 inside:true,
                 								 verticalAlign:'bottom',
                 								 align:'top',
                 								 color: "#666666",
                 								 padding :[0,0,16,0]
             							 },
                           tooltip: {
                                show:"false",
                                trigger: 'axis',
                                axisPointer: { // 坐标轴指示器，坐标轴触发有效
                                    type: 'shadow',
                                    shadowStyle : {                       // 阴影指示器样式设置
                                     width: 'auto',                   // 阴影大小
                                     }// 默认为直线，可选为：'line' | 'shadow'
                                }
                            },
                            data: ['北京三级','成都','南京','重庆','长沙']
                          },
                         {
                            type: 'category',
                            axisTick : {
                              show: false
                            },
                            axisLine: {
                              show: false
                            },
                            axisLabel :{
                              show: false
                           },
                            data: ['北京三级','成都','南京','重庆','长沙']
                        },

                ],
                series: [
                    {
                        name: '完成工单量',
                        type: 'bar',
                        yAxisIndex:1,
                        itemStyle:{
                            normal: {
                                show: true,
                                color: function (params){
                                    var colorList = ['#d6d3d3','#d6d3d3','#d6d3d3','#d6d3d3','#d6d3d3'];
                                    return colorList[params.dataIndex];
                                },
                                barBorderRadius:50,
                                borderWidth:0,
                                borderColor:'#333',
                            }
                        },
                        barGap:'0%',
                        barCategoryGap:'70%',
                        data: [ 230, 210, 125, 231, 132]
                    },
                    {
                        name: '派发工单量',
                        type: 'bar',
                        itemStyle:{
                            normal: {
                                show: true,
                                color: function (params){
                                    var colorList = ['#73c6e4','#8dbdf0','#eeb954','#98d73b','#6ec0de'];
                                    return colorList[params.dataIndex];
                                },
                                barBorderRadius:50,
                                borderWidth:0,
                                borderColor:'#333',
                            }
                        },
                        barGap:'0%',
                        barCategoryGap:'70%',
                        data: [10, 32, 25, 210, 32]
                    }

                ]
            };

           echarts.init(document.getElementById('container1')).setOption(option1);
        }

         function getWorkTime(){
           var chart = Highcharts.chart('container2', {
                credits: {
                     enabled: false
                },
                chart: {
                    type: 'area'
                },
                title: {
                    text: ''
                },
                xAxis: {
                    title: {
                        text: ''
                    },
        						tickmarkPlacement: 'on',
        						tickPosition: 'inside',
        						categories: ['1', '2', '3', '4', '5', '6',
        												 '7', '8', '9', '10', '11', '12'],
        					 labels: {
                           rotation: 0,
                           style: {
                               fontSize: '13px',
                           },
        									 y:-10
                       }
                },
                yAxis: {
        						min: 0,
        						gridLineWidth:0,
        						title: {
        								text: ''
        						},
        						labels: {
                        enabled: false
                    }
                },
                tooltip: {
                    crosshairs: true,
        						crosshairs: [{            // 设置准星线样式
        							    width: 12,
        							    color: "rgba(248,227,198,0.4)",
        									zIndex: 100
        						}],
                    shared: true
                },
                plotOptions: {
                    spline: {
                        marker: {
                            radius: 4,
                            lineColor: '#666666',
                            lineWidth: 1
                        },
        								events: {
        									 legendItemClick: function(e) {
        											 return false; // 直接 return false 即可禁用图例点击事件
        									 }
        							 }
                    },
        						area: {
        							 stacking: 'normal',
        							 lineColor: '#666666',
        							 lineWidth: 1,
        							 marker: {
        									 lineWidth: 1,
        									 lineColor: ''
        							 }
        					 }

                },
                series: [{
                    name: '一号基地',
                    marker: {
                        symbol: 'circle',
        								fillColor: '#c994cc'
                    },
        						showInLegend: false,//不显示图例
                    data: [7.0, 6.9, 9.5, 14.5, 18.2, 21.5, 25.2, {
                        y: 26.5
                    }, 23.3, 18.3, 13.9, 9.6],
        						color:"#faf5fb",
        						lineColor: '#c994cc'
                }, {
                    name: '二号基地',
                    marker: {
                        symbol: 'circle',
        								fillColor: '#37d4a1'
                    },
        						showInLegend: false,
                    data: [{
                        y: 3.9
                    }, 4.2, 5.7, 8.5, 11.9, 15.2, 17.0, 16.6, 14.2, 10.3, 6.6, 4.8],
        						color:"#eafbf5",
        						lineColor: '#37d4a1'
                }]
              });

         }
          function getlongNess(){
         	 $('#container3').highcharts({
          			credits: {
          					 enabled: false
          			},
          			chart: {
          					type: 'area',
          					spacingTop: 30,
          					backgroundColor:"#21bbff",
          					panning:true,
          					zoomType: 'x',
          					pinchType:'x',
          					followTouchMove: true
          			},
          			title: {
          					text: ''
          			},
          			xAxis: {
          				  tickmarkPlacement: 'on',
          					tickPosition: 'inside',
          					lineColor:'#fff',
          					tickColor:'#fff',
          					zIndex:100,
          					title: {
          							text: ''
          					},
          					categories: ['1', '2', '3', '4', '5', '6',
          											 '7', '8', '9', '10', '11', '12'],
          				 labels: {
          								 rotation: 0,
          								 style: {
          										 fontSize: '0.26rem',
          										 color:"#fff"
          								 },
          								 y:-15
          						 }
          			},
          			yAxis: {
          					min: 0,
          					lineColor:'#fff',
          					tickmarkPlacement: 'on',
          					tickPosition: 'inside',
          					gridLineWidth:0,
          					tickWidth:1,
          					lineWidth:1,
          					tickColor:'#fff',
          					title: {
          							text: ''
          					},
          					labels: {
          							style: {
          									fontSize: '0.26rem',
          									color:'#fff',
          									fontFamily: 'Verdana, sans-serif',
          						}
          					}
          			},
          			tooltip: {
          					crosshairs: true,
          					crosshairs:[{
          						width:28,
          						color:"rgba(250,250,250,0.2)",
          						zIndex: 100
          					}],
          					shared: true
          			},
          			plotOptions: {
          					spline: {
          							marker: {
          									radius: 4,
          									lineColor: '#666666',
          									lineWidth: 1
          							},
          							events: {
          								 legendItemClick: function(e) {
          										 return false; // 直接 return false 即可禁用图例点击事件
          								 }
          						 }
          					},
          					area: {
          						 stacking: 'normal',
          						 lineColor: '#666666',
          						 lineWidth: 1,
          						 marker: {
          								 lineWidth: 1,
          								 lineColor: '#fff'
          						 }
          				 }

          			},
          			series: [{
          					name: '一号地块',
          					marker: {
          							symbol: 'circle',
          					},
          					showInLegend: false,//不显示图例
          					data: [30,45,55,70,90,110,200,300,320,280,230,180],
          					color:'#21bbff',
          					lineColor: '#fff'
          			}]
          		});

          }

          /*
         * 获得时间差,时间格式为 年-月-日 小时:分钟:秒 或者 年/月/日 小时：分钟：秒
         * 其中，年月日为全格式，例如 ： 2010-10-12 01:00:00
         * 返回精度为：秒，分，小时，天
         */

         function GetDateDiff(startTime, endTime, diffType) {
             //将xxxx-xx-xx的时间格式，转换为 xxxx/xx/xx的格式
             startTime = startTime.replace(/\-/g, "/");
             endTime = endTime.replace(/\-/g, "/");

             //将计算间隔类性字符转换为小写
             diffType = diffType.toLowerCase();
             var sTime = new Date(startTime);      //开始时间
             var eTime = new Date(endTime);  //结束时间
             //作为除数的数字
             var divNum = 1;
             switch (diffType) {
                 case "second":
                     divNum = 1000;
                     break;
                 case "minute":
                     divNum = 1000 * 60;
                     break;
                 case "hour":
                     divNum = 1000 * 3600;
                     break;
                 case "day":
                     divNum = 1000 * 3600 * 24;
                     break;
                 default:
                     break;
             }
             return parseInt((eTime.getTime() - sTime.getTime()) / parseInt(divNum));
         }
  </script>
  </html>
