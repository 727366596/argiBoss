<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>技术推广列表搜索</title>
    <link rel="stylesheet" type="text/css" href="../../../css/common/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/common/reset.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/common/iscroll-style.css"/>
    <script type="text/javascript" src="../../../script/common/iscroll.js"></script>
    <script type="text/javascript" src="../../../script/common/rem.js"></script>
    <style>
    	  *{
            box-sizing: border-box;
        }
        html,body{
            width:100%;
            /*height:100%;*/
        }
        header{
            position: fixed;
            left: 0;
            top:0;
            /*top: 0.44rem;*/
            height:1.35rem;
            width: 100%;
            background: #00c558;
            z-index: 99;
        }
        header #title{
            position: relative;
            width:100%;
            height: 0.88rem;
            line-height: 0.88rem;
            text-align: center;
            font-size: 0.36rem;font-family: PingFangSC-Regular, sans-serif;color: #fff;
        }
        header #title span.right{
            display: inline-block;
						position: absolute;
						right: 13px;
						bottom: 0px;
            font-size: 0.32rem;font-family: PingFangSC-Regular, sans-serif;color: #fff;
        }

        .clearMsg{
          position: absolute;
          top: 2px;
          right: 6px;
          z-index: 999;
          height: 25px;
          width: 25px;
          background: url("../../../image/resend_password_emptyIcon.png") no-repeat center center;
          background-size: 15px 15px;
          display: none;
        }
        .searchBox{
          position: relative;
          width:5.0rem;
          height:0.6rem;
          border:solid 1px #f2f2f2;
          background: #fff;
          border-radius: 0.6rem;
          margin-top: 0.13rem;
        }
        .searchBox>input{
          position: absolute;
          top: 0;
          left: 15px;
          width: 100%;
          height: 100%;
          line-height: 0.6rem;
          padding-right: 40px;
          outline: none;
          font-size: 0.28rem;font-family: PingFangSC-Regular, sans-serif;color: #717475;
        }
        .main_content{

        }
				#wrapper{
            width:100%;
						position: fixed;
						left: 0;
						top: 1.35rem;
						bottom: 0;
						overflow: auto;
						z-index: 1;
						padding-bottom:1.0rem;
						background-color: #fff;
						text-align: center;
        }
        #wrapper .scroller,#wrapper .scroller>ul,#wrapper .scroller>ul>li{
            width:100%;
						text-align:center;
        }
				#wrapper .scroller,#wrapper .scroller>ul>span{
						/*margin: 10px 0;*/
						font-size: 0.32rem;font-family: PingFangSC-Regular, sans-serif;color: #747474;
				}
				#wrapper .scroller>ul>li{
					position: relative;
					width:100%;
					/*height:1.46rem;*/
					padding: 0.1rem 0.2rem;
					border-bottom: solid 1px #f3f3f4;
					display: -webkit-box;
					display: -webkit-flex;
					display:flex;

					-webkit-box-orient: horizontal;
					-webkit-flex-flow: row;
					flex-flow: row;

					-webkit-box-pack: justify;
					-webkit-justify-content: space-between;
					justify-content: space-between;

					-webkit-box-align: center;
					-webkit-align-items: center;
					align-items: center;
				}
				#wrapper .scroller>ul>li .transfer_content_left{
					position: relative;
					/*width: 4.27rem;*/
					/*width: 100%;*/
					height: 100%;
					padding: 0.2rem;
				}
				#wrapper .scroller>ul>li .transfer_content_left .transfer_content_info{
					/*width: 100%;*/
					word-break:break-all; word-wrap:break-word ;
				}
				#wrapper .scroller>ul>li .transfer_content_left .transfer_content_info>p{
					position: relative;
					width: 100%;
					/*height: 0.36rem;*/
					line-height: 0.36rem;
					text-align:left;font-size: 0.26rem;font-family: PingFangSC-Regular, sans-serif;color: #747474;
				}
				#wrapper .scroller>ul>li .transfer_content_left .transfer_content_info>p span{
					display: inline-block;
					height: 0.27rem;
					line-height: 0.3rem;
					margin-left: 0.1rem;
					padding-right: 0.1rem;
					text-indent: 0.3rem;font-size: 0.18rem;font-family: PingFangSC-Regular, sans-serif;color:#006ACD;
					border-radius: 0.03rem;
					background: url(../../image/home_transfer_content_tuijian.png) no-repeat 0.1rem center;
					background-size: 20% 60%;
					background-color: #f6f7fc;
				}
				#wrapper .scroller>ul>li .transfer_content_left .transfer_content_time>p{
					height: 0.2rem;
					line-height: 0.2rem;
					margin-top: 0.3rem;
					text-align:left;font-size: 0.2rem;font-family: PingFangSC-Regular, sans-serif;color: #AEADAD;
				}
				#wrapper .scroller>ul>li .transfer_content_right{
					/*width: 1.7rem;*/
					height: 1.12rem;
					position:relative;
					top:-0.08rem;
					left:-0.1rem;
				}
				#wrapper .scroller>ul>li .transfer_content_right img{
					width: 1.7rem;
					height: 100%;
					margin-top: 0.1rem;
				}

        .search_history_list{
            width: 95%;
						display: inline-block;
						border: solid 1px #f2f2f2;
						margin:10px auto;
        }
        .search_history_title{
          width: 100%;
          height: 0.8rem;
					line-height: 0.85rem;
					padding-left: 40px;
					background: url("../../../image/time.png") no-repeat 15px center;
					background-size: 20px 20px;
					text-align: left;
          font-size: 0.32rem;font-family: PingFangSC-Regular, sans-serif;color: #717475;
        }
        .search_history_list_content{
          padding: 15px;
					text-align: center;
					font-size: 0.32rem;font-family: PingFangSC-Regular, sans-serif;color: #717475;
        }
        .searchSpan{
        	/*position: relative;*/
          float: left;
          min-width: 1.5rem;
          padding: 5px 10px;
          text-align: center;
          border: solid 1px #717475;
					color: #717475;
					background-color: #f2f2f2;
					margin:5px 10px 5px 0;
          border-radius: 5px;
          font-size: 0.28rem;font-family: PingFangSC-Regular, sans-serif;
        }
				.searchSpan_active{
					/*position: relative;*/
          float: left;
          min-width: 1.5rem;
          padding: 5px 10px;
          text-align: center;
          border: solid 1px #82e268;
					color: #82e268;
					background-color: #fff;
					margin:5px 10px 5px 0;
          border-radius: 5px;
          font-size: 0.28rem;font-family: PingFangSC-Regular, sans-serif;
				}
        .clear_search_history_btn{
          display: none;
          border: solid 1px blue;
          padding: 5px 10px;
          border-radius: 6px;
          margin: 0.5rem auto;
          outline: none;
          font-size: 0.28rem;font-family: PingFangSC-Regular, sans-serif;color: #00f;
        }

				.ok{
					position: absolute;
					right: 0;
					top: 0;
					width: 0;
			    height: 0;
			    border-top: 16px solid #82e268;
			    border-left: 20px solid transparent;
				}
				.ic{
					position: absolute;
					right:2px;
					top: -14px;
					height: 5px;
					width: 8px;
					background: url("../../../image/delimit_ic.png") no-repeat left center;
					background-size: 100% 100%;
					z-index: 99;
				}
				.infoListWidth{
						width:75%;
				}
    </style>
</head>
<body>
    <header id="header">
        <div id="title">
            <span class="searchBox"><input type="text" name="transfer_search" id="transfer_search" placeholder="请输入搜索内容"/><i class="clearMsg" onclick="emptyInput()"></i></span>
            <span class="right" onclick="back()">取消</span>
        </div>
    </header>
    <div id="wrapper">
        <div class="scroller">
            <ul>
                <!-- <li onclick="openTechTransferInfo(1)">
                   <div class="transferContent">
                       <p>晚熟大王柑橘秋季管理要点：做好三点，带来丰产！</p>
                       <p>2017-08-09</p>
                   </div>
                   <div class="transferImg">
                       <img src="../../../image/home_technology_transfer_03.png">
                   </div>
                </li> -->

            </ul>
        </div>
				<div class="search_history_list">
            <p class="search_history_title">最近搜索</p>
            <div class="search_history_list_content clearFloat">
                <!-- <span>马铃薯</span>
                <span>西蓝花</span>
                <span>马铃薯</span>
                <span>河北省丰安天下第一种植基地</span>
                <span>马铃薯</span>
                <span>西蓝花</span>
                <span>马铃薯</span>
                <span>河北省丰安天下第一种植基地</span> -->
            </div>
        </div>
        <button type="button" name="button" class="clear_search_history_btn" onclick="empty_search_history()">清空历史记录</button>
    </div>
</body>
<script type="text/javascript" src="../../../script/common/api.js"></script>
<script type="text/javascript" src="../../../script/common/jquery.min.js"></script>
<script type="text/javascript" src="../../../script/common/pds.ajax.js"></script>
<script type="text/javascript">
	apiready = function(){
		//		沉浸式状态栏
		var header=$api.byId("header");
    $api.fixStatusBar(header);
		//获取搜索历史信息
		getHistoryData();
		//输入框清空按钮显示
    $("#transfer_search").focus(function(){
        $(".clearMsg").show();
    });
    //监听搜索框
    $("#transfer_search").on("change",function(){
        //alert($(this).val());
        var searchStr = $(this).val();
        getData(searchStr);
    });
	};

  //搜索请求数据
	var search_history_arr;
  function getData(searchStr){
			//保存搜索历史加入本地缓存
			var search_obj = {
					'searchStr' : searchStr
			};
			search_history_arr = $api.getStorage('search_history_list');
			//alert(JSON.stringify(search_history_arr));
			if(search_history_arr.length != 0){
					var search_history_flag = false;//记录是否追加本地缓存
					var search_history_flag_ = (function(){
							for (var j = 0; j < search_history_arr.length; j++) {
									if(search_history_arr[j].searchStr == searchStr){
											search_history_flag = true;//遍历本地缓存，有等值则不追加；否则追加
											return search_history_flag
									};
							};
					})();
					//通过flag判断是否追加本地缓存
					if(!search_history_flag_){
							search_history_arr.unshift(search_obj);
					};
			}else{
					search_history_arr.unshift(search_obj);
			};
			//需延时处理
			setTimeout(function(){
					$api.setStorage('search_history_list', search_history_arr);
					//重新获取历史搜索数据
					//alert(JSON.stringify(search_history_arr))
					if(!search_history_flag_){//有新增时才会重新请求搜索记录
							getHistoryData();
					};
			},500);
			pds.ajaxSubmit({
				 url:"/app/content/techContentList",
				 type : "get",
				 data:{"data":JSON.stringify({
						 page : 1,
						 pageSize : 10,
						 data : {
								 title : searchStr,
		 						 author : searchStr
						 }
				 })},
         success:function(e){
						//alert("success");
						//alert(JSON.stringify(e));
						if(e.total >= 0){
								var techListArr = e.data;
								var techListStr = "";
								var articleTypeName = null;
								if(techListArr != "" && techListArr != null && techListArr != []){
										for (var i = 0; i < techListArr.length; i++) {

												switch (techListArr[i].articleType) {
													case 11:
														articleTypeName = "农业技术"
														break;
													case 12:
														articleTypeName = "行业政策"
														break;
													case 13:
														articleTypeName = "农村生活"
														break;
												};
												var techDataImg = "", infoListWidth = "";
												if(techListArr[i].pictureUrl != "" && techListArr[i].pictureUrl != null){
														techDataImg = '<img style="width: 1.7rem;" src="'+ techListArr[i].pictureUrl +'">';
														infoListWidth = "infoListWidth";
												};
												techListStr += '<li class="" onclick="openTechTransferInfo('+ techListArr[i].contentId +')">'+
																					'<div class="transfer_content_left'+ " " + infoListWidth +'">'+
																							'<div class="transfer_content_info">'+
																									'<p>'+ techListArr[i].title +'</p>'+
																							'</div>'+
																							'<div class="transfer_content_time"><p><span>'+ articleTypeName +'</span><span style="margin-left:10px;">'+ (techListArr[i].createTime).split(" ")[0] +'</span><span style="margin-left:20px;">作者：'+ techListArr[i].author +'</span></p></div>'+
																					'</div>'+
																					'<div class="transfer_content_right">'+ techDataImg +'</div>'+
																			'</li>';
										};

										$("#wrapper .scroller ul").html(techListStr);
										$("#transfer_search").blur();
								}else{
										$("#wrapper .scroller ul").html("<span style='padding-top:20px;'>搜索无结果</span>");
								}

						};
         }
     });
  }

  //搜索历史数据
  function getHistoryData(){
      var search_history_list_arr = $api.getStorage('search_history_list');
			//alert(JSON.stringify(search_history_list_arr));
			if(search_history_list_arr != '' && search_history_list_arr != null && search_history_list_arr != []){
					$(".clear_search_history_btn").show();
					var search_history_list_str = "";
					for (var i = 0; i < search_history_list_arr.length; i++) {
						search_history_list_str += '<span class="spans searchSpan_active" onclick="getData($(this).text())">'+ search_history_list_arr[i].searchStr +'<i class="span_ok"><i><i class="span_ic"></i></span>';
					};
					//alert(JSON.stringify(search_history_list_str));
					$(".search_history_list_content").html(search_history_list_str);
					checkActive();
			}else{
					empty_search_history();
			}
  }
  //清空input框
  function emptyInput(){
	    $("#transfer_search").val("");
	    $(".clearMsg").hide();
  }
  //清空搜索历史
  function empty_search_history(){
      $(".search_history_list_content").html("暂无搜索历史记录");
			$("#wrapper .scroller ul").html("");
			$api.setStorage('search_history_list', []);
			//$api.clearStorage('search_history_list');
			$(".clear_search_history_btn").hide();
			emptyInput();
  };

	//搜索历史字段按钮点击样式
	function checkActive(){
			$(".search_history_list_content span").off("click").on("click",function(){
					$(".spans").css({"backgroundColor" : "#fff"})
					$(this).css({
							"backgroundColor" : "#E4FFDD"
					});
					// $(".span_ok").removeClass("ok");
					// $(".span_ic").removeClass("ic");
					//$(this).removeClass("searchSpan").addClass("searchSpan_active");
					// $(this).next(".span_ok").addClass("ok");
					// $(this).next(".span_ic").addClass("ic");
			})
	}

	//打开技术详情页面***************************************************
	function openTechTransferInfo(id){
		api.openWin({
			name : "frm_home_tech_transfer_info",
			url : "widget://html/home/techTransfer/win_home_tech_transfer_info.html",
			reload : true,
			selecteIndex : '3',
			slidBackEnabled : false,
			pageParam : {
					contentId : id
			},
			animation : {
				type : "movein", //动画类型（详见动画类型常量）
				subType : "from_right", //动画子类型（详见动画子类型常量）
				duration : 300 //动画过渡时间，默认300毫秒
			}
		});
	};

	//返回上一级********************************************************************
	function back() {
			api.closeWin();
	}
</script>
</html>
